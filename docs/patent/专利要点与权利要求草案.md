# LLMCouncil-Optimization：专利要点与权利要求草案（对话整理）

> 本文整理自两轮对话结果：
> 1) “专利重点内容 + 核心伪代码”
> 2) “技术方案摘要（300~600字）+ 权利要求骨架”

---

## 第一轮：需要列入专利的重点内容、核心伪代码

### 一、建议列入专利的重点内容（技术特征 + 协同效果）

#### A. 可配置的多阶段多Agent讨论编排（Pipeline）
- 会话级编排控制：对同一会话绑定参与专家集合、Chairman、知识库文档集合、（可选）图谱标识，并可通过设置开关启用/关闭阶段（Stage0/2B/2C）与轮数。
- 阶段化执行与可追溯事件流：每个阶段 start/complete 事件落 trace（以及流式 SSE 返回给前端），形成可审计的推理链。

**效果**：让“多模型讨论”从一次性对话变成可复用的分析工作流；不同任务可选择不同流程组合与强度（速度/成本/可靠性）。

#### B. 会话绑定文档 → 知识库（SQLite）→ 混合检索 → 上下文注入
- 文档入库切分：文本按 chunk_size/overlap 切片并写入 FTS 表与 chunk 表。
- 混合检索：FTS（BM25）+ 语义检索（embeddings）+ 可选 rerank；支持会话 doc_id 过滤、Agent doc_id/分类过滤。
- 嵌入索引策略：支持入库后自动索引（或查询时补全），并持久化 embedding 向量。
- 降级策略：embedding/rerank 失败自动回退为启发式/FTS，保证流程可运行。

**效果**：面向真实文件分析稳定可用；检索质量与可控性提升；对模型/网络波动不敏感。

#### C. Stage0 发送前预处理（摘要/拆分/提问题，结构化）
- 基于“会话绑定的 KB 文档集合”，对原始材料进行摘要、提炼关键问题、建议子任务，输出结构化 JSON，并作为 system 注入 Stage1。

**效果**：降低长文输入噪音、统一分析视角，提高后续多Agent初稿质量与一致性。

#### D. Stage2 匿名互评（可解析的排名格式）
- 把 Stage1 多个回答匿名化为 Response A/B/C…，要求模型输出中文评审 + 固定英文 `FINAL RANKING:` 排名块，以便机器解析并聚合。

**效果**：减少模型偏见/“认人”；让互评结果可计算、可追溯、可用于后续综合。

#### E. Stage2B 圆桌讨论（基于人设+真实网页信息+会话文档）
- 各 Agent 依据自身 persona 与专属检索结果进行互动讨论，要求点名回应其他 Agent，并优先引用 URL/KB[doc_id] 作为依据；轮数可配置。

**效果**：把“多模型并排”升级为“有约束的互动推演”，更接近真实讨论过程，并强化证据意识。

#### F. Stage2C 事实核查与证据归因（结构化 claims JSON）
- 抽取关键主张 claims，并对每条主张给出 supported/uncertain/refuted 状态、证据列表（URL / KB[doc_id]）、置信度，输出严格 JSON。

**效果**：把“回答”变成可验证的“主张-证据”结构，显著降低胡编，便于后续复用/审计/出报告。

#### G. Agent级网页检索（每人独立，带并发限制与 trace）
- 可选开启“每个 Agent 自己检索”，将结果只注入该 Agent 的上下文；带并发限制避免限流；并记录每个 Agent 的 query 与结果。

**效果**：不同角色/人设可形成不同检索视角，减少信息同质化；全程可追溯。

#### H. 图谱闭环（可选）
- 文档抽取→Neo4j 存储→子图查询→作为上下文注入；并支持节点/社区摘要与解读。

**效果**：把非结构化文本转为结构化关系网络，增强跨文档的关联推理与可视化解释。

---

### 二、核心伪代码（可直接作为说明书“实施例/流程”）

#### 1) 会话级总流程（Pipeline Orchestrator）
```pseudo
function RUN_PIPELINE(conversation_id, user_query):
    settings = LOAD_SETTINGS()
    agents = GET_CONVERSATION_AGENTS(conversation_id)

    // Stage0: preprocess (optional)
    preprocess = null
    if settings.enable_preprocess:
        preprocess = PREPROCESS_DOCS(conversation_id, user_query)   // JSON

    // Stage1: first opinions
    stage1_results = parallel_map(agents, agent =>
        STAGE1_AGENT_RESPONSE(agent, conversation_id, user_query, preprocess)
    )

    // Stage2: anonymous peer review
    stage2_results, label_map = parallel_map_with_meta(agents, agent =>
        STAGE2_AGENT_RANK(agent, conversation_id, user_query, stage1_results)
    )
    aggregate_rankings = AGGREGATE_RANKINGS(stage2_results, label_map)

    // Stage2B: roundtable (optional, multi-round)
    roundtable = []
    if settings.enable_roundtable and settings.roundtable_rounds > 0:
        repeat settings.roundtable_rounds times:
            roundtable = parallel_map(agents, agent =>
                STAGE2B_AGENT_DISCUSS(agent, conversation_id, user_query, stage1_results, stage2_results)
            )

    // Stage2C: fact check (optional)
    fact_check = null
    if settings.enable_fact_check:
        fact_check = FACT_CHECK_JSON(conversation_id, user_query, stage1_results, stage2_results, roundtable)

    // Stage3: chairman synthesis
    chairman = GET_CHAIRMAN(conversation_id)
    stage3_final = CHAIRMAN_SYNTHESIZE(chairman, user_query, stage1_results, stage2_results, roundtable, fact_check)

    TRACE_SAVE(conversation_id, all_stage_inputs_outputs)
    return {stage1_results, stage2_results, stage3_final,
            metadata={label_map, aggregate_rankings, preprocess, roundtable, fact_check}}
```

#### 2) Stage1：单个 Agent 的上下文构建与回答
```pseudo
function STAGE1_AGENT_RESPONSE(agent, conversation_id, user_query, preprocess):
    sys_msgs = []
    if agent.persona: sys_msgs.append(agent.persona)
    sys_msgs.append(LANGUAGE_REQUIREMENT)

    realtime_ctx = BUILD_REALTIME_CONTEXT(user_query)    // date + global web search (optional)
    if realtime_ctx: sys_msgs.append("可用外部信息:\n" + realtime_ctx)

    if preprocess != null:
        sys_msgs.append("文档预处理摘要:\n" + FORMAT(preprocess))

    knowledge = BUILD_AGENT_KNOWLEDGE(agent, conversation_id, user_query)
    if knowledge: sys_msgs.append(knowledge)

    user_msg = user_query
    resp = LLM_CALL(agent.model_spec, sys_msgs + [user_msg])
    return {agent_id, agent_name, model_spec, response=resp}
```

#### 3) Agent Knowledge：KB 混合检索 +（可选）Agent专属网页检索 +（可选）图谱子图
```pseudo
function BUILD_AGENT_KNOWLEDGE(agent, conversation_id, user_query):
    parts = []

    // per-agent web search (optional)
    if settings.enable_agent_web_search:
        query = user_query + " " + agent.name
        results = DDG_SEARCH(query, k=settings.agent_web_search_results, concurrency_limit=3)
        TRACE(web_search_agent, agent, query, results)
        parts.append(FORMAT_WEB_RESULTS(results))

    // KB retrieval
    doc_scope = GET_CONVERSATION_DOC_IDS(conversation_id)         // optional
    agent_scope = agent.kb_doc_ids / agent.kb_categories          // optional
    hits = HYBRID_SEARCH(user_query, doc_scope ∩ agent_scope)
        // FTS BM25 + embedding cosine + optional rerank
        // fail -> fallback heuristic/FTS
    TRACE(kb_hits, agent, hits, kb_settings)
    parts.append(FORMAT_KB_HITS(hits))

    // KG subgraph (optional)
    if agent.graph_id:
        subgraph = NEO4J_QUERY_SUBGRAPH(agent.graph_id, user_query)
        TRACE(kg_subgraph, agent, subgraph)
        parts.append(FORMAT_SUBGRAPH(subgraph))

    return JOIN(parts)
```

#### 4) Stage2：匿名互评与可解析排名
```pseudo
function STAGE2_AGENT_RANK(agent, conversation_id, user_query, stage1_results):
    labels = ASSIGN_LABELS(stage1_results)         // Response A/B/C...
    prompt = BUILD_RANKING_PROMPT(user_query, labels, stage1_results)
        // 要求 FINAL RANKING: + "1. Response X" 机器可解析
    resp = LLM_CALL(agent.model_spec, [agent.persona + prompt])
    parsed = PARSE_FINAL_RANKING(resp)
    return {agent_id, ranking_text=resp, parsed_ranking=parsed, vote_weight=WEIGHT(agent)}
```

#### 5) Stage2C：事实核查结构化输出
```pseudo
function FACT_CHECK_JSON(conversation_id, user_query, stage1, stage2, roundtable):
    sys = "输出严格JSON: claims[{claim,status,evidence[{type,ref,note}],confidence}], open_questions[]"
    material = {web_results, kb_doc_list, stage1, stage2, roundtable}
    resp = LLM_CALL(chairman_model, [sys, JSON(material)])
    json_obj = EXTRACT_JSON_OBJECT(resp)
    TRACE(stage2c, json_obj, raw=resp)
    return json_obj
```

#### 6) 写权利要求时建议强调的限定点词条
- 会话绑定的文档标识集合 doc_ids 与图谱标识 graph_id
- 阶段化编排：预处理阶段、初稿阶段、互评阶段、圆桌讨论阶段、事实核查阶段、综合阶段
- 匿名化互评并输出可解析排名格式
- 混合检索：全文检索与向量检索融合，并具备重排与失败降级机制
- 事实核查输出 claims-evidence 结构化 JSON，其中 evidence 引用 URL 或 KB[doc_id]
- 分阶段事件流（SSE）与 trace 落盘，实现可追溯审计

---

## 第二轮：技术方案摘要（300~600字）+ 权利要求骨架

### 1) 技术方案摘要（建议放“发明内容/摘要”）
本发明公开一种面向文本数据分析的多模型讨论与证据化生成方法及系统。该系统在会话层绑定知识库文档标识集合与可选图谱标识，并以可配置的阶段化流程驱动多个 Agent 协同生成结果。流程包括：发送前预处理阶段，对会话绑定文档进行摘要、关键问题提炼与任务拆分并输出结构化结果；初稿阶段，各 Agent 基于其人设、实时信息与会话范围知识库检索结果生成独立回答；互评阶段，将各回答匿名化为固定代号并要求输出可机器解析的排名格式，以实现排序聚合；圆桌讨论阶段，各 Agent 基于人设与网页检索信息展开点名互动并引用证据；事实核查阶段，抽取关键主张并以 URL 或知识库文档标识为证据归因输出结构化 JSON；综合阶段，由主席模型融合初稿、互评、互动与核查结果输出最终结论。系统提供混合检索机制，融合全文检索与向量检索并支持重排与失败降级，提供分阶段事件流与全过程 trace 落盘，实现可追溯、可配置、稳定的文本分析与讨论解读。

### 2) 权利要求骨架（方法类为主，系统类可镜像）

#### 权利要求1（方法）
一种基于多智能体的大模型文本数据分析与证据化生成方法，其特征在于，包括：
1) 获取用户在会话中的输入文本问题，并读取与该会话绑定的知识库文档标识集合；
2) 按预设的阶段化流程执行多智能体协同生成，所述阶段化流程至少包括初稿阶段、互评阶段与综合阶段；
3) 在初稿阶段，为每个智能体构建输入上下文，所述上下文至少包括该智能体的人设信息与基于所述会话绑定的知识库文档标识集合检索得到的片段信息，并分别调用对应模型生成各自的初稿输出；
4) 在互评阶段，将所述初稿输出匿名化为固定代号集合，并调用至少一个智能体对匿名化输出进行评价与排序，且排序结果采用可机器解析的固定格式输出；
5) 在综合阶段，调用主席模型将所述初稿输出与互评排序结果融合生成最终输出；
6) 将所述阶段化流程中至少一部分输入、输出与中间结果记录为可追溯的过程数据。

#### 权利要求2（从属：会话绑定与过滤）
根据权利要求1所述的方法，其特征在于，所述会话绑定的知识库文档标识集合用于限定检索范围，使得初稿阶段的检索仅在所述集合对应的文档或其分块中进行。

#### 权利要求3（从属：预处理阶段 Stage0）
根据权利要求1所述的方法，其特征在于，在初稿阶段之前还包括预处理阶段：对所述会话绑定的知识库文档内容进行摘要、结构拆分与关键问题提炼，生成结构化预处理结果，并将该预处理结果作为系统提示信息注入至初稿阶段的各智能体上下文中。

#### 权利要求4（从属：混合检索）
根据权利要求1所述的方法，其特征在于，所述检索采用混合检索机制，至少包括：全文检索得到的第一候选集合与向量相似度检索得到的第二候选集合，并按预设融合规则生成用于上下文注入的检索片段集合。

#### 权利要求5（从属：嵌入索引策略）
根据权利要求4所述的方法，其特征在于，对知识库文档分块在入库后基于嵌入模型生成向量并持久化存储；当发现缺失向量时执行补全计算，以保证向量检索可用。

#### 权利要求6（从属：重排与失败降级）
根据权利要求4所述的方法，其特征在于，对融合后的候选集合执行重排模型的相关性重排；当重排或嵌入计算失败时，自动降级为不依赖重排或向量的排序方式以继续输出检索片段集合。

#### 权利要求7（从属：互评输出格式可解析）
根据权利要求1所述的方法，其特征在于，互评阶段的排序结果包含固定英文标签与编号列表，且列表项仅由“序号+代号”构成，以便解析并统计聚合。

#### 权利要求8（从属：圆桌讨论 Stage2B）
根据权利要求1所述的方法，其特征在于，在互评阶段之后还包括圆桌讨论阶段：对至少部分智能体分别调用模型生成互动发言，所述互动发言至少包含对其它智能体输出的点名回应，并允许引用外部网页检索结果与知识库文档标识作为依据。

#### 权利要求9（从属：每Agent独立网页检索）
根据权利要求8所述的方法，其特征在于，为不同智能体分别执行网页检索并将检索结果仅注入对应智能体的上下文中，且对检索并发进行限制以控制资源占用或限流风险。

#### 权利要求10（从属：事实核查结构化输出 Stage2C）
根据权利要求1所述的方法，其特征在于，在互评阶段之后还包括事实核查阶段：抽取与问题相关的关键主张集合，并为每条主张输出支持/不确定/反驳状态、证据引用与置信度，所述证据引用至少包含 URL 或知识库文档标识，从而形成结构化 JSON 输出。

#### 权利要求11（从属：综合阶段使用核查结果）
根据权利要求10所述的方法，其特征在于，综合阶段在生成最终输出时优先采纳证据更充分的主张，并在最终输出中标注不确定性与风险提示。

#### 权利要求12（从属：知识图谱注入）
根据权利要求1所述的方法，其特征在于，会话或智能体绑定图谱标识，并从图数据库中根据所述问题查询子图，将子图节点与关系摘要作为上下文注入至初稿阶段或圆桌讨论阶段。

#### 权利要求13（从属：分阶段事件流）
根据权利要求1所述的方法，其特征在于，系统以分阶段事件流向前端发送各阶段开始与结束事件，并在事件中携带对应阶段的结果数据，以实现过程可视化与交互式展示。

#### 权利要求14（系统权利要求镜像）
一种实现权利要求1至13任一所述方法的系统，包括：会话管理模块、知识库管理模块、检索与重排模块、多智能体编排模块、网页检索模块、事实核查模块、以及过程追溯模块；其中各模块协同执行所述阶段化流程并输出最终结果。
